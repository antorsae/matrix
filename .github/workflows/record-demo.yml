name: Record Demo GIF

on:
  workflow_dispatch:
  push:
    paths:
      - 'matrix.py'
    branches:
      - main

jobs:
  record:
    # Prevent infinite loop - skip if commit was made by this action
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'Update demo.gif')"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ffmpeg first
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gifsicle

      - name: Install VHS
        uses: charmbracelet/vhs-action@v2
        with:
          install-fonts: true

      - name: Create VHS tape
        run: |
          cat > demo.tape << 'EOF'
          Set Shell bash
          Set FontSize 14
          Set Width 800
          Set Height 400
          Set Theme "Monokai"
          Set TypingSpeed 50ms

          Type "python matrix.py"
          Enter
          Sleep 5s
          Ctrl+C
          EOF

      - name: Record demo
        run: vhs demo.tape -o demo.gif

      - name: Optimize GIF
        run: gifsicle -O3 --colors 128 demo.gif -o demo.gif

      - name: Commit demo.gif
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add demo.gif
          git diff --staged --quiet || git commit -m "Update demo.gif [skip ci]"
          git push
